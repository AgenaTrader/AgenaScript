<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Events - AgenaScript Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../custom.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Events";
    var mkdocs_page_input_path = "events.md";
    var mkdocs_page_url = "/AgenaScript-documentation/index.html/events/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74646070-1', 'agenatrader.github.io');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> AgenaScript Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Lets start</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../handling_bars_and_instruments/">Handling bars and instruments</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Events</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#events">Events</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#onbrokerconnect">OnBrokerConnect()</a></li>
        
            <li><a class="toctree-l3" href="#onbrokerdisconnect">OnBrokerDisconnect()</a></li>
        
            <li><a class="toctree-l3" href="#oncalculate">OnCalculate()</a></li>
        
            <li><a class="toctree-l3" href="#onchartpanelmousedown">OnChartPanelMouseDown()</a></li>
        
            <li><a class="toctree-l3" href="#onchartpanelmousemove">OnChartPanelMouseMove()</a></li>
        
            <li><a class="toctree-l3" href="#ondispose">OnDispose()</a></li>
        
            <li><a class="toctree-l3" href="#onlevel1">OnLevel1()</a></li>
        
            <li><a class="toctree-l3" href="#onlevel2">OnLevel2()</a></li>
        
            <li><a class="toctree-l3" href="#onorderchanged">OnOrderChanged()</a></li>
        
            <li><a class="toctree-l3" href="#onorderexecution">OnOrderExecution()</a></li>
        
            <li><a class="toctree-l3" href="#onstart">OnStart()</a></li>
        
            <li><a class="toctree-l3" href="#onstop">OnStop()</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../strategy_programming/">Strategy programming</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../keywords/">Keywords</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../drawing_objects/">Drawing objects</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../hints_and_advice/">Hints and advice</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">AgenaScript Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Events</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/AgenaTrader/AgenaScript-documentation/edit/master/sources/events.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="events">Events</h1>
<p>AgenaTrader is an <em>event-oriented</em> application by definition.</p>
<p>Programming in AgenaTrader using the various application programming interface (<em>API</em>) methods is based initially on the <em>Overwriting</em> of routines predefined for event handling.</p>
<p>The following methods can be used and therefore overwritten:</p>
<ul>
<li><a href="#onbrokerconnect"><em>OnBrokerConnect()</em></a></li>
<li><a href="#onbrokerdisconnect"><em>OnBrokerDisconnect()</em></a></li>
<li><a href="#oncalculate"><em>OnCalculate()</em></a></li>
<li><a href="#onchartpanelmousedown"><em>OnChartPanelMouseDown()</em></a></li>
<li><a href="#onchartpanelmousemove"><em>OnChartPanelMouseMove()</em></a></li>
<li><a href="#ondispose"><em>OnDispose()</em></a></li>
<li><a href="#onlevel1"><em>OnLevel1()</em></a></li>
<li><a href="#onlevel2"><em>OnLevel2()</em></a></li>
<li><a href="#onorderchanged"><em>OnOrderChanged()</em></a></li>
<li><a href="#onorderexecution"><em>OnOrderExecution()</em></a></li>
<li><a href="#onstart"><em>OnStart()</em></a></li>
<li><a href="#onstop"><em>OnStop()</em></a></li>
</ul>
<h2 id="onbrokerconnect">OnBrokerConnect()</h2>
<h3 id="description">Description</h3>
<p>OnBrokerConnect() method is invoked each time the connection to the broker is established.  With the help of OnBrokerConnect(), it is possible to reassign the existing or still open orders to the strategy in the event of a connection abort with the broker and thus allow it to be managed again.</p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter">Parameter</h3>
<p>none</p>
<h3 id="usage">Usage</h3>
<pre><code class="cs">protected override void OnBrokerConnect()
</code></pre>

<h3 id="example">Example</h3>
<pre><code class="cs">private IOrder _takeProfit = null;
private IOrder _trailingStop = null;


protected override void OnBrokerConnect()
{
   if (Trade != null &amp;&amp; Trade.PositionType != PositionType.Flat)
   {
       _takeProfit = Orders.FirstOrDefault(o =&gt; o.Name == this.GetType().Name &amp;&amp; o.OrderType ==OrderType.Limit);
       _trailingStop = Orders.FirstOrDefault(o =&gt; o.Name == this.GetType().Name &amp;&amp; o.OrderType ==OrderType.Stop);
   }
}

</code></pre>

<h2 id="onbrokerdisconnect">OnBrokerDisconnect()</h2>
<h3 id="description_1">Description</h3>
<p>OnBrokerDisconnect() method is invoked each time the connection to the broker is interrupted.</p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter_1">Parameter</h3>
<p>An object from <em>TradingDatafeedChangedEventArgs</em></p>
<h3 id="usage_1">Usage</h3>
<pre><code class="cs">protected override void OnBrokerDisconnect(TradingDatafeedChangedEventArgs e)
</code></pre>

<h3 id="example_1">Example</h3>
<pre><code class="cs">protected override void OnBrokerDisconnect(TradingDatafeedChangedEventArgs e)
{
   if (e.Connected)
       Print(&quot;The connection to the broker will be disconnected.&quot;);
   else
       Print(&quot;The connection to the broker was disconnected.&quot;);
}
</code></pre>

<h2 id="oncalculate">OnCalculate()</h2>
<h3 id="description_2">Description</h3>
<p>The OnCalculate() method is called up whenever a bar changes; depending on the variables of <a href="#calculateonclosedbar"><em>CalculateOnClosedBar</em></a>, this will happen upon every incoming tick or when the bar has completed/closed.
OnCalculate is the most important method and also, in most cases, contains the largest chunk of code for your self-created indicators or strategies.
The editing begins with the oldest bar and goes up to the newest bar within the chart. The oldest bar has the number 0. The indexing and numbering will continue to happen; in order to obtain the numbering of the bars you can use the current bar variable. You can see an example illustrating this below.</p>
<p><strong>Caution:</strong>
<strong>the numbering/indexing is different from the bar index – see <a href="#Bars"><em>Bars</em></a>.</strong></p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter_2">Parameter</h3>
<p>none</p>
<h3 id="usage_2">Usage</h3>
<pre><code class="cs">protected override void OnCalculate()
</code></pre>

<h3 id="example_2">Example</h3>
<pre><code class="cs">protected override void OnCalculate()
{
    Print(&quot;Calling of OnCalculate for the bar number &quot; + ProcessingBarIndex + &quot; from &quot; +Time[0]);
}
</code></pre>

<h2 id="onchartpanelmousedown">OnChartPanelMouseDown()</h2>
<h3 id="description_3">Description</h3>
<p>In an indicator, or strategy, the click event of the mouse can be processed. For this, it is necessary to program an EventHandler as a method and add this method to the Chart.ChartPanelMouseDown event.</p>
<h3 id="attention">Attention!</h3>
<p>It is important to remove the EventHandler from the OnDispose() method, otherwise the EventHandler will still be executed even if the indicator has been removed from the chart.</p>
<h3 id="example_3">Example</h3>
<pre><code class="cs">using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Linq;
using System.Xml;
using System.Xml.Serialization;
using AgenaTrader.API;
using AgenaTrader.Custom;
using AgenaTrader.Plugins;
using AgenaTrader.Helper;


namespace AgenaTrader.UserCode
{
       public class ChartPanelMouseDown : UserIndicator
       {
               protected override void OnInit()
               {
                       IsOverlay = true;
               }

               protected override void OnStart()
               {
                       // Add event listener
                       if (Chart != null)
                               Chart.ChartPanelMouseDown += OnChartPanelMouseDown;
               }


               protected override void OnDispose()
               {
                       // Remove event listener
                       if (Chart != null)
                               Chart.ChartPanelMouseDown -= OnChartPanelMouseDown;
               }


               private void OnChartPanelMouseDown(object sender,System.Windows.Forms.MouseEventArgs e)
               {
                       Print(&quot;X = {0}, Y = {1}&quot;, Chart.GetDateTimeByX(e.X),Chart.GetPriceByY(e.Y));
               }
       }
}
</code></pre>

<h2 id="onchartpanelmousemove">OnChartPanelMouseMove()</h2>
<h3 id="description_4">Description</h3>
<p>In an indicator, or strategy, the current position of the mouse can be evaluated and processed. For this, it is necessary to program an EventHandler as a method and add this method to the Chart.ChartPanelMouseMove event.</p>
<h3 id="attention_1">Attention!</h3>
<p>It is important to remove the EventHandler from the OnDispose() method, otherwise the EventHandler will still be executed even if the indicator has been removed from the chart.</p>
<h3 id="example_4">Example</h3>
<pre><code class="cs">using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Linq;
using System.Xml;
using System.Xml.Serialization;
using AgenaTrader.API;
using AgenaTrader.Custom;
using AgenaTrader.Plugins;
using AgenaTrader.Helper;


namespace AgenaTrader.UserCode
{
    public class ChartPanelMouseMove : UserIndicator
    {
        protected override void OnInit()
        {
            IsOverlay = true;
        }

        protected override void OnStart()
        {
            // Add event listener
            if (Chart != null)
                Chart.ChartPanelMouseMove += OnChartPanelMouseMove;
        }

        protected override void OnDispose()
        {
            // Remove event listener
            if (Chart != null)
                Chart.ChartPanelMouseMove -= OnChartPanelMouseMove;
        }

        private void OnChartPanelMouseMove(object sender, System.Windows.Forms.MouseEventArgs e)
        {
            Print(&quot;X = {0}, Y = {1}&quot;, Chart.GetDateTimeByX(e.X), Chart.GetPriceByY(e.Y));
        }
    }
}
</code></pre>

<h2 id="ondispose">OnDispose()</h2>
<h3 id="description_5">Description</h3>
<p>The OnDispose() method can also be overridden in order to once again free up all the resources used in the script.</p>
<p>See <a href="#oninit"><em>OnInit()</em></a> and <a href="#onstart"><em>OnStart()</em></a>.</p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter_3">Parameter</h3>
<p>none</p>
<h3 id="usage_3">Usage</h3>
<pre><code class="cs">protected override void OnDispose()
</code></pre>

<h3 id="more-information">More Information</h3>
<p><strong>Caution:</strong>
<strong>Please do not override the Dispose() method since this can only be used much later within the script. This would lead to resources being used and held for an extended period and thus potentially causing unexpected consequences for the entire application.</strong></p>
<h3 id="example_5">Example</h3>
<pre><code class="cs">protected override void OnDispose()
{
    if (Window != null)
    {
        Window.Dispose();
        Window = null;
    }
}
</code></pre>

<h2 id="onlevel1">OnLevel1()</h2>
<h3 id="description_6">Description</h3>
<p>The OnLevel1() method is called up when a change in level 1 data has occurred, meaning whenever there is a change in the bid price, ask price, bid volume, or ask volume, and of course in the last price after a real turnover has occurred.
In a multibar indicator, the rocessingBarSeriesIndex property identifies the data series that was used for an information request for OnLevel1().
OnLevel1() will not be called up for historical data.
More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<p><strong>Notes regarding data from Yahoo (YFeed)</strong></p>
<p>The field "LastPrice" equals – as usual – either the bid price or the ask price, depending on the last revenue turnover.</p>
<p>The MarketDataType" field always equals the "last" value</p>
<p>The fields "Volume", "BidSize" and "AskSize" are always 0.</p>
<h3 id="usage_4">Usage</h3>
<pre><code class="cs">protected override void OnLevel1(Level1Args e)
</code></pre>

<h3 id="parameter_4">Parameter</h3>
<pre><code class="cs">[*Level1Args*] e
</code></pre>

<h3 id="example_6">Example</h3>
<pre><code class="cs">protected override void OnLevel1(Level1Args e)
{
    Print(&quot;AskPrice &quot;+e.AskPrice);
    Print(&quot;AskSize &quot;+e.AskSize);
    Print(&quot;BidPrice &quot;+e.BidPrice);
    Print(&quot;BidSize &quot;+e.BidSize);
    Print(&quot;Instrument &quot;+e.Instrument);
    Print(&quot;LastPrice &quot;+e.LastPrice);
    Print(&quot;MarketDataType &quot;+e.MarketDataType);
    Print(&quot;Price &quot;+e.Price);
    Print(&quot;Time &quot;+e.Time);
    Print(&quot;Volume &quot;+e.Volume);
}
</code></pre>

<h2 id="onlevel2">OnLevel2()</h2>
<h3 id="description_7">Description</h3>
<p>The OnLevel2() method is called up whenever there is a change in the level 2 data (market depth).
In a multibar indicator, the ProcessingBarSeriesIndex property identifies the data series for which the OnLevel2() method is called up.
OnLevel2 is not called up for historical data.</p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="usage_5">Usage</h3>
<pre><code class="cs">protected override void OnLevel2(Level2Args e)
</code></pre>

<h3 id="parameter_5">Parameter</h3>
<p>An object from <em>Level2Args</em></p>
<h3 id="example_7">Example</h3>
<pre><code class="cs">protected override void OnLevel2(Level2Args e)
{
    // Current Bit-Price
    if (e.MarketDataType == MarketDataType.Bit)
        Print(&quot;The current bit is &quot; + e.Price );
}
</code></pre>

<h2 id="onorderchanged">OnOrderChanged()</h2>
<h3 id="description_8">Description</h3>
<p>The OnOrderChanged() method is called up whenever the status is changed by a strategy-managed order.
A status change can therefore occur due to a change in the volume, price or status of the exchange (from “working” to “filled”). It is guaranteed that this method will be called up in the correct order for the relevant events.</p>
<p><strong>Important note:</strong>
<strong>If a strategy is to be controlled by order executions, we highly recommend that you use OnOrderExecution() instead of OnOrderChanged(). Otherwise there may be problems with partial executions.</strong></p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter_6">Parameter</h3>
<p>An order object of the type IOrder</p>
<h3 id="usage_6">Usage</h3>
<pre><code class="cs">protected override void OnOrderChanged(IOrder order)
</code></pre>

<h3 id="example_8">Example</h3>
<pre><code class="cs">private IOrder entry = null;
protected override void OnCalculate()
{
    if (CrossAbove(EMA(14), SMA(50), 1) &amp;&amp; IsSerieRising(ADX(20)))
        entry = OpenLong(&quot;EMACrossesSMA&quot;);

    if (entry != null &amp;&amp; entry == order)
    {
        if (order.OrderState == OrderState.Filled)
        {
        PlaySound(&quot;OrderFilled.wav&quot;);
        entryOrder = null;
        }
    }
}
protected override void OnOrderChanged(IOrder order)
{

}
</code></pre>

<h2 id="onorderexecution">OnOrderExecution()</h2>
<h3 id="description_9">Description</h3>
<p>The OnOrderExecution() method is called up when an order is executed (filled).
The status of a strategy can be changed by a strategy-managed order. This status change can be initiated by the changing of a volume, price or the status of the exchange (from “working” to “filled”). It is guaranteed that this method will be called up in the correct order for all events.</p>
<p>OnOrderExecution() will always be executed AFTER <a href="#onorderchanged"><em>OnOrderChanged()</em></a>.</p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter_7">Parameter</h3>
<p>An execution object of the type <em>IExecution</em></p>
<h3 id="usage_7">Usage</h3>
<pre><code class="cs">protected override void OnOrderExecution(IExecution execution)
</code></pre>

<h3 id="example_9">Example</h3>
<pre><code class="cs">private IOrder entry = null;
protected override void OnCalculate()
{
    if (CrossAbove(EMA(14), SMA(50), 1) &amp;&amp; IsSerieRising(ADX(20)))
            entry = OpenLong(&quot;EMACrossesSMA&quot;);
}
protected override void OnOrderExecution(IExecution execution)
{
    // Example
    if (entry != null &amp;&amp; execution.Order == entry)
    {
        Print(execution.Price.ToString());
    Print(execution.Order.OrderState.ToString());
    }
}
</code></pre>

<h2 id="onstart">OnStart()</h2>
<h3 id="description_10">Description</h3>
<p>The OnStart() method can be overridden to initialize your own variables, perform license checks or call up user forms etc.
OnStart() is only called up once at the beginning of the script, after <a href="#oninit"><em>OnInit()</em></a> and before <a href="#oncalculate"><em>OnCalculate()</em></a> are called up.</p>
<p>See <a href="#ondispose"><em>OnDispose()</em></a>.</p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter_8">Parameter</h3>
<p>none</p>
<h3 id="usage_8">Usage</h3>
<pre><code class="cs">protected override void OnStart()
</code></pre>

<h3 id="example_10">Example</h3>
<pre><code class="cs">private myForm Window;
protected override void OnStart()
{
    if (Chart != null)
    {
    Window = new myForm();
    Window.Show();
    }
}
</code></pre>

<h2 id="onstop">OnStop()</h2>
<h3 id="description_11">Description</h3>
<p>The OnStop() method is called up once a script is terminated. This can be when e.g. an indicator was removed from the chart or a column with an indicator / a scripted condition was removed from the scanner. </p>
<p>See <a href="#ondispose"><em>OnDispose()</em></a>.</p>
<p>More information can be found here: <a href="#events"><em>Events</em></a>.</p>
<h3 id="parameter_9">Parameter</h3>
<p>none</p>
<h3 id="usage_9">Usage</h3>
<pre><code class="cs">protected override void OnStop()
</code></pre>

<h3 id="example_11">Example</h3>
<pre><code class="cs">protected override void OnStop()
{
    Log(&quot;Stop: &quot; + this.ToString() + &quot; | &quot; + Instrument.Symbol, InfoLogLevel.Info); 
}

</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../strategy_programming/" class="btn btn-neutral float-right" title="Strategy programming">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../handling_bars_and_instruments/" class="btn btn-neutral" title="Handling bars and instruments"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/AgenaTrader/AgenaScript-documentation/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../handling_bars_and_instruments/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../strategy_programming/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
